<link rel="stylesheet" type="text/css" href="landofeem.css">
<!--********* PC SHEET **********-->
<div class="container">
    <div class="pc">
        <div class="header">
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content two-columns"><label for="attr_character_name" data-i18n="name-and-pronouns">Name
                            & Pronouns</label><input type="text" id="attr_character_name"
                            name="attr_character_name" /><label for="attr_class" data-i18n="class">Class</label><input
                            type="text" id="attr_class" name="attr_class" />
                    </div>
                </div>
            </div>
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content two-columns"><label for="attr_folk" data-i18n="folk">Folk</label><input
                            type="text" id="attr_folk" name="attr_folk" /><label for="attr_homeland"
                            data-i18n="homeland">Homeland</label><input type="text" id="attr_homeland"
                            name="attr_homeland" /></div>
                </div>
            </div>
            <div class="xp-rows">
                <img src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/xp.png"
                    class="xp-background" />
                <div class="corner-box-wrapper">
                    <div class="corner-box">
                        <div class="content two-columns"><label for="attr_lv" data-i18n="lv">LV</label><input
                                type="number" name="attr_lv" /></div>
                    </div>
                </div>
                <div class="corner-box-wrapper">
                    <div class="corner-box">
                        <div class="content two-columns"><label for="attr_xp" data-i18n="xp">XP</label><input
                                type="number" name="attr_xp" /></div>
                    </div>
                </div>
            </div>
            <img src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/logo-flat.png"
                alt="Land of Eem Logo" class="logo" />
        </div>
        <!--********* NAV BAR **********-->
        <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="attributes" />
        <div class="nav-bar">
            <button type="action" name="act_attributes" class="sheet-button0"
                data-i18n="attributes-and-abilities">Attributes</button>
            <button type="action" name="act_inventory" class="sheet-button1"
                data-i18n="inventory-and-crafting">Inventory</button>
            <button type="action" name="act_background" class="sheet-button2"
                data-i18n="personality-and-backstory">Background</button>
            <button type="action" name="act_notes" class="sheet-button3" data-i18n="notes-and-portrait">Journal</button>
        </div>
        <!--********* SHEET - ATTRIBUTES & ABILITIES **********-->
        <div class="sheet-attributes">
            <div class="attribute-box">
                <div>
                    <button type="action" name="act_vim">
                        <h2 data-i18n="vim">Vim</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_vim" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_charm" /></li>
                    <li><input type="text" name="attr_inspire" /></li>
                    <li><input type="text" name="attr_mettle" /></li>
                    <li><input type="text" name="attr_perception" /></li>
                </ul>
                <ul>
                    <li><button type="roll" name="roll_charm" data-i18n="charm" value="/roll d12">Charm</button></li>
                    <li><button type="roll" name="roll_inspire" data-i18n="inspire" value="/roll d12">Inspire</button>
                    </li>
                    <li><button type="roll" name="roll_mettle" data-i18n="mettle" value="/roll d12">Mettle</button></li>
                    <li><button type="roll" name="roll_perception" data-i18n="perception"
                            value="/roll d12">Perception</button></li>
                </ul>
            </div>
            <div class="stat-box stat-courage">
                <h2 data-i18n="courage">Courage</h2>
                <input type="number" name="attr_courage_max" class="big" />
                <input type="number" name="attr_courage" class="small" />
                <label data-i18n="current" class="small">Current</label>
            </div>
            <div class="corner-box-wrapper side" style="grid-row-end: span 3;">
                <label class="corner-box-header" data-i18n="proficiencies">Proficiencies</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_proficiencies" rows="3"></textarea></div>
                </div>
                <label class="corner-box-header" data-i18n="conditions">Conditions</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_conditions" rows="3"></textarea></div>
                </div>
            </div>
            <div class="corner-box-wrapper side" style="grid-row-end: span 3;">
                <label class="corner-box-header" data-i18n="deficiencies">Deficiencies</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_deficiencies" rows="3"></textarea></div>
                </div>
                <label class="corner-box-header" data-i18n="heroic-titles">Heroic Titles</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_heroic_titles" rows="3"></textarea></div>
                </div>
            </div>
            <div class="separator"></div>
            <div></div>
            <div class="attribute-box">
                <div>
                    <button type="roll" name="roll_vigor" value="/roll d12">
                        <h2 data-i18n="vigor">Vigor</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_vigor" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_athletics" /></li>
                    <li><input type="text" name="attr_intimidate" /></li>
                    <li><input type="text" name="attr_might" /></li>
                    <li><input type="text" name="attr_vitality" /></li>
                </ul>
                <ul>
                    <li><button type="roll" name="roll_athletics" data-i18n="athletics"
                            value="/roll d12">Athletics</button></li>
                    <li><button type="roll" name="roll_intimidate" data-i18n="intimidate"
                            value="/roll d12">Intimidate</button></li>
                    <li><button type="roll" name="roll_might" data-i18n="might" value="/roll d12">Might</button></li>
                    <li><button type="roll" name="roll_vitality" data-i18n="vitality"
                            value="/roll d12">Vitality</button></li>
                </ul>
            </div>
            <div class="stat-box stat-attack">
                <button type="roll" name="roll_attack" value="/roll d12">
                    <h2 data-i18n="attack">Attack</h2>
                </button>
                <input type="text" name="attr_attack" class="big" />
                <input type="text" name="attr_dread" class="small" />
                <label data-i18n="dread" for="attr_dread" class="small">Dread</label>
                <div style="display:block; width: 0; height: 0; overflow: visible;"><img
                        style="opacity: 0.2; min-width: 97px ; min-height: 97px;"
                        src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/stats_2.png" /></div>
            </div>
            <div class="separator"></div>
            <div></div>
            <div style="grid-column-end: span 2; grid-row-end: span 4;" class="note-box">
                <div style="margin-top: -6px;">
                    <h2 data-i18n="perks-and-abilities">Perks & Abilities</h2>
                    <textarea name="attr_abilities" rows="9"></textarea>
                </div>
            </div>
            <div class="attribute-box">
                <div>
                    <button type="roll" name="roll_knack" value="/roll d12">
                        <h2 data-i18n="knack">Knack</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_knack" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_nimbleness" /></li>
                    <li><input type="text" name="attr_search" /></li>
                    <li><input type="text" name="attr_sneak" /></li>
                    <li><input type="text" name="attr_trickery" /></li>
                </ul>
                <ul>
                    <li><button type="roll" name="roll_nimbleness" data-i18n="nimbleness"
                            value="/roll d12">Nimbleness</button></li>
                    <li><button type="roll" name="roll_search" data-i18n="search" value="/roll d12">Search</button></li>
                    <li><button type="roll" name="roll_sneak" data-i18n="sneak" value="/roll d12">Sneak</button></li>
                    <li><button type="roll" name="roll_trickery" data-i18n="trickery"
                            value="/roll d12">Trickery</button></li>
                </ul>
            </div>
            <div class="stat-box stat-defense">
                <button type="roll" name="roll_defense" value="/roll d12">
                    <h2 data-i18n="defense">Defense</h2>
                </button>
                <input type="text" name="attr_defense" class="big" />
                <input type="number" name="attr_block" class="small" />
                <label data-i18n="block" for="attr_block" class="small">Block</label>
            </div>
            <div class="separator"></div>
            <div></div>
            <div class="attribute-box">
                <div>
                    <button type="roll" name="roll_knowhow" value="/roll d12">
                        <h2 data-i18n="knowhow">Knowhow</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_knowhow" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_lore" /></li>
                    <li><input type="text" name="attr_realms" /></li>
                    <li><input type="text" name="attr_tinker" /></li>
                    <li><input type="text" name="attr_wilderness" /></li>
                </ul>
                <ul>
                    <li><button type="roll" name="roll_lore" data-i18n="lore" value="/roll d12">Lore</button></li>
                    <li><button type="roll" name="roll_realms" data-i18n="realms" value="/roll d12">Realms</button></li>
                    <li><button type="roll" name="roll_tinker" data-i18n="tinker" value="/roll d12">Tinker</button></li>
                    <li><button type="roll" name="roll_wilderness" data-i18n="wilderness"
                            value="/roll d12">Wilderness</button></li>
                </ul>
            </div>
            <div class="stat-box stat-quest">
                <h2 data-i18n="quest">Quest Pts.</h2>
                <input type="number" name="attr_quest_pts" class="big" />
            </div>
        </div>
        <!--********* SHEET - INVENTORY AND CRAFTING **********-->
        <div class="sheet-inventory">
            <div class="stripe upper">
                <section>
                    <h2 class="inventory" data-i18n="inventory">Inventory</h2>
                    <h2 data-i18n="slots">Slots:</h2>
                    <input class="small" type="number" name="attr_inventory_slots" />
                    <h2 class="small">/</h2><input class="small" type="number" name="attr_inventory_slots_max" />
                    <div class="checkbox-group">
                        <input type="checkbox" name="attr_overburdened" />
                        <label data-i18n="overburdened" for="attr_overburdened">Overburdened</label>
                        <input type="checkbox" name="attr_tired" />
                        <label data-i18n="tired" for="attr_tired">Tired</label>
                    </div>
                </section>
                <section>
                    <div class="treasure"><input type="text" name="attr_treasure_hunting" /></div>
                    <button class="treasure" type="roll" name="roll_treasure_hunting" value="/roll d12">
                        <h2 class="treasure" data-i18n="treasure-hunting">Treasure Hunting:</h2>
                    </button>
                </section>
            </div>
            <div class="inventory-upper">
                <div class="note-box">
                    <div>
                        <h2 class="worn" data-i18n="worn">Worn</h2>
                        <textarea rows="6" name="attr_worn"></textarea>
                        <div class="watermark worn"><img class="worn"
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/worn.png" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <h2 class="carried" data-i18n="carried">Carried</h2>
                        <textarea rows="6" name="attr_carried"></textarea>
                        <div class="watermark carried"><img class="carried"
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/carried.png" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="stripe lower">
                <section>
                    <img class="crafting"
                        src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/crafting.png" />
                    <h2 data-i18n="crafting">Crafting</h2>
                    <div class="corner-box-wrapper">
                        <div class="corner-box-wrapper">
                            <div class="corner-box">
                                <div class="content two-columns"><label data-i18n="num-materials">No. of
                                        materials</label><input type="number" name="attr_material_number" /></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <img class="coins"
                        src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/coins.png" />
                    <h2 data-i18n="coins">Coins</h2>
                    <section class="hint" data-i18n="tradeup">3:1 tradeup</section>
                </section>
                <section>
                    <img class="rations"
                        src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/rations.png" />
                    <h2 data-i18n="rations">Rations</h2>
                </section>
            </div>
            <div class="inventory-lower">
                <div class="note-box">
                    <div>
                        <div class="crafting fake-textarea">
                            <textarea rows="2" name="attr_material_elemental"></textarea>
                            <textarea rows="2" name="attr_material_fish"></textarea>
                            <textarea rows="2" name="attr_material_beast"></textarea>
                            <textarea rows="2" name="attr_material_herb"></textarea>
                        </div>
                        <div class="crafting-icons">
                            <img
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/material_elemental.png" />
                            <img
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/material_fish.png" />
                            <img
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/material_beast.png" />
                            <img
                                src="https://raw.githubusercontent.com/blaze-sanecki/LandOfEem/main/images/material_herb.png" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <div class="coins fake-textarea">
                            <section class="small" data-i18n="copper">Copper</section>
                            <section class="hint">d6</section><input type="number" name="attr_coins_copper" />
                            <section class="small" data-i18n="silver">Silver</section>
                            <section class="hint">d8</section><input type="number" name="attr_coins_silver" />
                            <section class="small" data-i18n="gold">Gold</section>
                            <section class="hint">d10</section><input type="number" name="attr_coins_gold" />
                            <section class="small" data-i18n="ancient">Ancient</section>
                            <section class="hint">d12</section><input type="number" name="attr_coins_ancient" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <div class="rations fake-textarea">
                            <section class="hint">d6</section><input type="number" name="attr_rations_d6" />
                            <section class="hint">d8</section><input type="number" name="attr_rations_d8" />
                            <section class="hint">d10</section><input type="number" name="attr_rations_d10" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--********* SHEET - BACKGROUND AND NOTES **********-->
        <div class="sheet-background">
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content">
                        <label class="hint" data-i18n="ideals">Ideals</label>
                        <section class="sparkle">&#x1F7C5;</section>
                        <section data-i18n="ideals-hint" class="hint">Gain individual XP if you demonstrate your ideals
                        </section>
                        <textarea rows="3" name="attr_ideals"></textarea>
                    </div>
                </div>
            </div>
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content">
                        <label class="hint" data-i18n="flaws">Flaws</label>
                        <section class="sparkle">&#x1F7C5;</section>
                        <section data-i18n="flaws-hint" class="hint">Gain individual XP if you demonstrate your flaws
                        </section>
                        <textarea rows="3" name="attr_flaws"></textarea>
                    </div>
                </div>
            </div>
            <div style="grid-column-end: span 2;"></div>
            <div class="note-box">
                <div>
                    <h2 data-i18n="personal-quest" class="hint">Personal Quest</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="personal-quest-hint" class="hint">Gain party XP if you pursue your personal
                        quest</section>
                    <textarea rows="5" name="attr_personal_quest"></textarea>
                </div>
            </div>
            <div class="note-box" style="grid-row-end: span 2;">
                <div>
                    <h2 data-i18n="backstory" class="hint">Backstory</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="backstory-hint" class="hint">Gain individual XP if you tell a story about your
                        past</section>
                    <textarea rows="13" name="attr_backstory"></textarea>
                </div>
            </div>
            <div class="note-box">
                <div style="margin-top: 12px;">
                    <h2 data-i18n="relationships" class="hint">Relationships</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="relationships-hint" class="hint">Gain party XP if you build on a relationship
                    </section>
                    <textarea rows="6" name="attr_relationships"></textarea>
                </div>
            </div>
        </div>
        <!--********* NOTES **********-->
        <div class="sheet-notes">
            <div class="note-box">
                <div>
                    <h2 data-i18n="other-notes" class="hint">Notes</h2>
                    <textarea rows="18" name="attr_other_notes"></textarea>
                </div>
            </div>
        </div>
    </div>
    <!--********* FOOTER **********-->
    <div class="footer">
        <span>Character Sheet (v.<span name="attr_version"></span>) by </span><a
            href="https://github.com/blaze-sanecki/LandOfEem">Blaze
            Sanecki</a>, made with a blessing from <span>by Ben Costa & James Parks</span> - creators of the <a
            href="https://landofeem.com/"><b>Land of Eem</b></a>.
    </div>
</div>
<!--********* HIDDEN ATTRIBUTES **********-->
<input type="hidden" name="attr_version" value="1.0.0" />

<!--********* ROLL TEMPLATE **********-->
<rolltemplate class="sheet-rolltemplate-check">
    <div class="sheet-template-container">
        <h1>{{name}}</h1>
        <div class="sheet-results">
            <h4>Result = {{roll}}</h4>
            <h4>Custom Result = {{computed::roll}}</h4>
            <h4 class="clearRoll">Custom Expression = {{computed::hint}}</section></h4>
            {{#rollTotal() computed::roll roll}}
            <div style="display:none">
            {{/rollTotal() computed::roll roll}}
            <h4>Result differs!!!</h4>
            {{#rollTotal() computed::roll roll}}
            </div>
            {{/rollTotal() computed::roll roll}}
        </div>
    </div>
</rolltemplate>

<!--********* SCRIPTS **********-->
<script type="text/worker">
//********* TAB BUTTONS **********/
const buttonlist = ["attributes", "inventory", "background", "notes"]
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTab: button
        })
    })
})

//********* DEFINE SIGNED AND UNSIGNED ATTRIBUTES **********/
const signed = ["attack", "defense", "vim", "charm", "inspire", "mettle", "perception", "vigor", "athletics", "intimidate", "might", "vitality", "knack", "nimbleness", "search", "sneak", "trickery", "knowhow", "lore", "realms", "tinker", "wilderness", "treasure_hunting"];
const unsigned = ["courage", "courage_max", "quest_pts", "block", "inventory_slots", "inventory_slots_max", "material_number", "coins_copper", "coins_silver", "coins_gold", "coins_ancient", "rations_d6", "rations_d8", "rations_d10", "lv", "xp"];

//********* VALIDATE SIGNED NUMBER VALUES ON CHANGE **********/
on(signed.map(field => "change:" + field).join(" "), (eventinfo) => {
    const fieldName = eventinfo.sourceAttribute
    getAttrs([fieldName], (values) => {
        if(eventinfo.sourceType === "sheetworker") {
            return
        }
        let val = parseInt(values[fieldName])
        if(isNaN(val)) {
            setAttrs({
              [fieldName]: "+0"
            })
        }
        else if(val < -3) {
            setAttrs({
              [fieldName]: "-3"
            })
        }
        else if(val > 3) {
            setAttrs({
              [fieldName]: "+3"
            })
        }
        else if(val >= 0) {
            setAttrs({
                [fieldName]: "+" + val
            })
        }
        else {
            setAttrs({
                [fieldName]: val
            })
        }
    })
})
//********* VALIDATE UNSIGNED NUMBER VALUES ON CHANGE (FOR FIREFOX BROWSER) **********/
on(unsigned.map(field => "change:" + field).join(" "), (eventinfo) => {
    const fieldName = eventinfo.sourceAttribute
    getAttrs([fieldName], (values) => {
        let val = parseInt(values[fieldName])
        if(isNaN(val)) {
            setAttrs({
                [fieldName]: eventinfo.previousValue || 0
            })
        }
    })
})
//********* VALIDATE ALL NUMBER VALUES ON CHARACTER SHEET OPEN **********/
on("sheet:opened", (eventinfo) => {
    signed.forEach((fieldName) => {
        getAttrs([fieldName], (values) => {
            let val = parseInt(values[fieldName])
            if(isNaN(val)) {
                setAttrs({
                [fieldName]: "+0"
                })
            }
            else if(val < -3) {
                setAttrs({
                [fieldName]: "-3"
                })
            }
            else if(val > 3) {
                setAttrs({
                [fieldName]: "+3"
                })
            }
            else if(val >= 0) {
                setAttrs({
                    [fieldName]: "+" + val
                })
            }
            else {
                setAttrs({
                    [fieldName]: val
                })
            }
        })
    })
    unsigned.forEach((fieldName) => {
        getAttrs([fieldName], (values) => {
            if(values[fieldName] === "") {
                setAttrs({
                    [fieldName]: 0
                })
            }
        })
    })
    //********* SET DEFAULT VALUES FOR SOME OF THE TEXT FIELDS **********/
    getAttrs(["dread"], (values) => {
        const val = values["dread"]
        if(val === undefined || val === "") {
            setAttrs({
                dread: "1d4"
            })
        }
    })

    //********* SET ROLL EVENT LISTENERS *********/
    signed.forEach((s) => {
        on(`clicked:${s}`, () => {
            getAttrs([s], values => {
                let v = parseInt(values[s])
                if(v >= 0) v = "+" + v
                startRoll(`&{template:check} {{name=${s} check}} {{roll=[[?{Check Type|Standard, 1d12|Advantage, 2d12kh1|Disadvantage, 2d12kl1}?{Modifier|${v}}]]}} {{hint=[[0]]}}`, (checkResult) => {
                    console.log(checkResult)
                    let modifier = checkResult.results.roll.dice[0]
                    let expression = checkResult.results.roll.expression
                    if(expression.startsWith("2d12kl1")){
                        expression = "2d12kl1"
                        if(modifier > checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
                    }
                    else if (expression.startsWith("2d12kh1")){
                        expression = "2d12kh1"
                        if(modifier < checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
                    }
                    else expression = "1d12"
                    modifier = checkResult.results.roll.result - modifier
                    console.log("Modifier without highest die: " + modifier)
                    let computedResult = checkResult.results.roll.result
                    if(modifier > 3)
                        computedResult = computedResult - modifier + 3
                    else if(modifier < -3)
                        computedResult = computedResult - modifier - 3
                    expression = expression + (modifier > 3 ? "+3" : modifier < -3 ? "-3" : modifier >=0 ? "+"+modifier : modifier)
                    checkResult.results.hint.expression = ""
                    finishRoll(checkResult.rollId, {
                        roll: computedResult,
                        hint: expression
                    })
                })
            })
        })
    })
})
</script>